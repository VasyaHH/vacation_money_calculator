<!doctype html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Расчет отпускных</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script src="js/static/lodash.js"></script>
	<script src="js/static/dayjs/dayjs.min.js"></script>
	<script src="js/static/dayjs/customParseFormat.js"></script>
	<script>
		dayjs.extend(window.dayjs_plugin_customParseFormat)
	</script>

	<script src="js/static/vue.global.js"></script>
</head>

<body>
<div id="app" v-cloak>
	<div class="app-columns">
		<fieldset>
			<legend><b>Период отпуска</b></legend>
			<small>Указать дату начала отпуска и его продолжительность в днях</small>
			Начало: <input type="text" v-model="vacation_start"/>
			Кол-во дней: <input type="text" v-model="vacation_length"/>
			Конец: <span>{{vacationEnd}}</span>
			<div v-if="getHolidaysCount()">

			</div>
		</fieldset>
		<fieldset>
			<legend><b>Дата приема на работу</b></legend>
			Дата: <input type="text" v-model="employmentDate"/>
		</fieldset>
		<fieldset>
			<legend><b>Расчетный период</b></legend>
			Начало: <input type="text" v-model="calc_period.start"/>
			Конец: <input type="text" v-model="calc_period.end"/>
			<div v-for="error in calcPeriodErrors" class="red-color">
				{{error}}
			</div>
		</fieldset>
		<fieldset>
			<legend>Исключения из периода: <b>отпуск</b></legend>
			<small>Учитываются праздники при подсчете продолжительности указанного периода</small>
			<div v-for="(period, idx) in vacationsFilledDaysCount">
				Начало: <input :value="period.start"
							   @input="datePlaceholderChangeHandler($event, types.vacation, idx, 'start')"
							   ref="recentVacationInput"
							   :class="{'date-invalid': period.start && !isValidDate(period.start)}"
			/>
				Конец: <input :value="period.end"
							  @input="datePlaceholderChangeHandler($event, types.vacation, idx, 'end')"
							  :class="{'date-invalid': period.end && !isValidDate(period.end)}"
							  @keydown.enter="addVacationPeriodRow()"/>
				Дней: <span v-if="isValidDate(period.start) && isValidDate(period.end)">
							{{period.length}}
							<span v-for="p in period.sickPeriods"> (БЛ: {{p.start}} - {{p.end}})</span>
							<span v-if="period.holidaysCount"> (праздн. дней - {{period.holidaysCount}})</span>
					  </span>
				<div v-if="period.sickPeriods.length && !period.hasProlongation" class="red-color">
					Нет продления отпуска
				</div>
				<div v-for="error in excludedPeriodsErrors[period.originIndex]" class="red-color">
					{{error}}
				</div>
			</div>
			<button type="button" @click="addVacationPeriod()" style="margin: 10px 0" class="no-print">
				Добавить период
			</button>
		</fieldset>

		<fieldset>
			<legend>Исключения из периода: <b>продление отпуска</b></legend>
			<small>Учитываются праздники при подсчете продолжительности указанного периода</small>
			<div v-for="(period, idx) in vacationProlongationsFilledWithSick">
				Начало: <input :value="period.start"
							   @input="datePlaceholderChangeHandler($event, types.vacation_prolongation, idx, 'start')"
							   ref="vacationProlongationInput"
							   :class="{'date-invalid': period.start && !isValidDate(period.start)}"
			/>
				Конец: <input :value="period.end"
							  @input="datePlaceholderChangeHandler($event, types.vacation_prolongation, idx, 'end')"
							  :class="{'date-invalid': period.end && !isValidDate(period.end)}"
							  @keydown.enter="addVacationProlongationPeriod()"/>
				Дней:	<span v-if="isValidDate(period.start) && isValidDate(period.end)">
							{{period.length}}
						</span>
				<div v-for="error in excludedPeriodsErrors[period.originIndex]" class="red-color">
					{{error}}
				</div>
			</div>
			<button
					class="no-print"
					type="button"
					@click="addVacationProlongationPeriod()"
					style="margin: 10px 0"
			>
				Добавить период
			</button>
		</fieldset>

		<fieldset>
			<legend>Исключения из периода: <b>больничный лист</b></legend>
			<small><b>НЕ</b> учитываются праздники при подсчете продолжительности указанного периода</small>
			<div v-for="(period, idx) in sickPeriods">
				Начало: <input :value="period.start"
							   @input="datePlaceholderChangeHandler($event, types.sick, idx, 'start')"
							   ref="sickPeriodInput"
							   :class="{'date-invalid': period.start && !isValidDate(period.start)}"
			/>
				Конец: <input :value="period.end"
							  @input="datePlaceholderChangeHandler($event, types.sick, idx, 'end')"
							  :class="{'date-invalid': period.end && !isValidDate(period.end)}"
							  @keydown.enter="addSickPeriod()"/>
				Дней: <span v-if="isValidDate(period.start) && isValidDate(period.end)">
							{{daysBetweenDatesInclusive(period.start, period.end)}}
					  </span>
				<div v-for="error in excludedPeriodsErrors[period.originIndex]" class="red-color">
					{{error}}
				</div>
			</div>
			<button type="button" @click="addSickPeriod()" style="margin: 10px 0" class="no-print">
				Добавить период
			</button>
		</fieldset>
		<fieldset>
			<legend>Исключения из периода: <b>отпуск без сохранения ЗП</b></legend>
			<small><b>НЕ</b> учитываются праздники при подсчете продолжительности указанного периода</small>
			<div v-for="(period, idx) in leaveOfAbsencePeriods">
				Начало: <input :value="period.start"
							   @input="datePlaceholderChangeHandler($event, types.leave_of_absence, idx, 'start')"
							   ref="leaveOfAbsenceInput"
							   :class="{'date-invalid': period.start && !isValidDate(period.start)}"
			/>
				Конец: <input :value="period.end"
							  @input="datePlaceholderChangeHandler($event, types.leave_of_absence, idx, 'end')"
							  :class="{'date-invalid': period.end && !isValidDate(period.end)}"
							  @keydown.enter="addLeaveOfAbsencePeriod()"/>
				Дней: <span v-if="isValidDate(period.start) && isValidDate(period.end)">
							{{daysBetweenDatesInclusive(period.start, period.end)}}
					  </span>
				<div v-for="error in excludedPeriodsErrors[period.originIndex]" class="red-color">
					{{error}}
				</div>
			</div>
			<button type="button" @click="addLeaveOfAbsencePeriod()" style="margin: 10px 0" class="no-print">
				Добавить период
			</button>
		</fieldset>

		<fieldset>
			<legend><b>Средний дневной заработок</b></legend>
			<input type="text" v-model="workerSum"/>
		</fieldset>
	</div>
	<div class="app-columns">
		<fieldset v-if="errors.length" class="error-fieldset">
			<legend><b>Ошибки</b></legend>
			<div v-for="error in errors">{{error}}</div>
		</fieldset>

		<fieldset>
			<legend><b>Расчетная таблица</b></legend>
			<table class="result-table">
				<tr>
					<th>Месяц.Год</th>
					<th>Кол-во рабочих дней</th>
				</tr>
				<tr v-for="row in resultTable"
					:class="{'not-full-month': !row.isFullMonth}"
				>
					<td>{{row.monthYear}}</td>
					<td>{{row.workDays}}</td>
				</tr>
			</table>
		</fieldset>

		<fieldset>
			<legend>Расчеты</legend>
			<div>
				<fieldset>
					Средний дневной заработок - <b>{{avgSum.toFixed(2)}}</b> руб.
				</fieldset>
				<fieldset>
					Отработано дней в периоде - <b>{{totalWorkingDays.toFixed(2)}}</b> руб.
				</fieldset>
				<fieldset>
					Сумма отпускных - {{(avgSum * vacation_length).toFixed(2)}} ({{vacation_length}} &times; {{avgSum}})
				</fieldset>
				<fieldset>
					НДФЛ - {{(avgSum * vacation_length * 0.13).toFixed(2)}}
				</fieldset>
				<fieldset>
					На руки - {{(avgSum * vacation_length * 0.87).toFixed(2)}}
				</fieldset>

				<!--
				<pre>{{JSON.stringify(this.splitByMonthPeriods, null, 2)}}</pre>
				<pre>{{JSON.stringify(this.excludedPeriodsWithStopVacationAfterSick, null, 2)}}</pre>
				<div>{{JSON.stringify(this.splitByMonthPeriods)}}</div>
				<div>{{JSON.stringify(this.notWorkingDays)}}</div>
				<pre>{{JSON.stringify(this.calcPeriods, null, 1)}}</pre>
				-->
			</div>
		</fieldset>
	</div>
</div>
<script src="js/app.js"></script>
</body>
</html>
